datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  createdAt     DateTime  @default(now())
  
  sessions      ChatSession[]
}

model ChatSession {
  id        String   @id @default(cuid())
  userId    String
  title     String   @default("New Chat")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
  branches  Branch[]
  // Optional: Link to a workspace if this session is attached to a repo
  workspace Workspace?
}

model Branch {
  id             String   @id @default(cuid())
  chatSessionId  String
  name           String   @default("Main")
  defaultModelId String   @default("gpt-4o") // default fallback
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  session        ChatSession @relation(fields: [chatSessionId], references: [id], onDelete: Cascade)
  messages       Message[]
}

model Message {
  id              String   @id @default(cuid())
  branchId        String
  role            String   // "system", "user", "assistant"
  content         String   // Text content
  modelId         String?  // Specific model used for this message (if assistant)
  createdAt       DateTime @default(now())
  
  // The Recursive Tree Structure
  parentMessageId String?
  parentMessage   Message?  @relation("ThreadHistory", fields: [parentMessageId], references: [id])
  childMessages   Message[] @relation("ThreadHistory")

  branch          Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
}

model Workspace {
  id            String   @id @default(cuid())
  chatSessionId String   @unique
  repoUrl       String   // e.g. "https://github.com/user/repo"
  baseBranch    String   @default("main")
  isSynced      Boolean  @default(false)
  createdAt     DateTime @default(now())

  chatSession   ChatSession @relation(fields: [chatSessionId], references: [id], onDelete: Cascade)
}
